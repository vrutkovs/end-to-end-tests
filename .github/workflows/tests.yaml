name: "Tests"

on:
  push:
    branches:
      - main

env:
  SUITE_SMOKE: "smoke_test"
  SUITE_LOAD: "load_test"
  SUITE_CHAOS: "chaos_test"
  GH_PAGES_URL: "https://victoriametrics.github.io/end-to-end-tests"

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          check-latest: true
          cache: true
        id: go

      - name: Download go packages
        run: |
          go mod download

      - name: Run unit tests
        run: |
          go test ./pkg/... -v -count=1

  kind-smoke-test:
    name: Kind smoke test (${{ matrix.vm_version }})
    runs-on: ubuntu-latest
    needs: unit-tests
    strategy:
      matrix:
        vm_version:
          - "v1.131.0"
          - "v1.131.0-enterprise"
          - "v1.122.10-enterprise"
          - "v1.110.25-enterprise"
      fail-fast: false
    outputs:
      tests: ${{ steps.tests.outcome }}
    permissions:
      checks: write
      contents: write
    if: github.event.pull_request.draft == false
    env:
      LABEL_FILTER: kind
      VM_VERSION: ${{ matrix.vm_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          check-latest: true
          cache: true
        id: go

      - name: Install ginkgo
        run: |
          go install github.com/onsi/ginkgo/v2/ginkgo

      - name: Download go packages
        run: |
          go mod download

      - name: Install helm
        uses: yokawasa/action-setup-kube-tools@v0.13.1
        with:
          setup-tools: |
            helmv3
            kubectl

      - name: Create Kind cluster
        uses: helm/kind-action@v1.13.0
        with:
          config: manifests/kind.yaml

      - name: Add helm repo
        run: |
          helm repo add vm https://victoriametrics.github.io/helm-charts/
          helm repo update

      - name: Install crust-gather
        uses: jaxxstorm/action-install-gh-release@v1.10.0
        with:
          repo: crust-gather/crust-gather
          platform: linux
          arch: amd64

      - name: Install VMExporter
        uses: jaxxstorm/action-install-gh-release@v1.10.0
        with:
          repo: VictoriaMetrics/support
          platform: linux
          arch: amd64
          token: ${{ secrets.PAT }}
          extension-matching: disable
          rename-to: vmexporter
          chmod: 0755

      - name: Run e2e tests
        id: tests
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission
          mkdir -p /tmp/allure-results
          ginkgo -v \
            -procs=0 \
            -github-output=true \
            -timeout=30m \
            --label-filter=${{ env.LABEL_FILTER }} \
            ./tests/${{ env.SUITE_SMOKE }} \
            -- \
            -env-k8s-distro=kind \
            -vmtag=${{ matrix.vm_version }} \
            -report=/tmp/allure-results

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kind-${{ env.SUITE_SMOKE }}-${{ matrix.vm_version }}
          path: /tmp/allure-results

  kind-load-test:
    name: Kind load test (${{ matrix.vm_version }})
    runs-on: ubuntu-latest
    needs: kind-smoke-test
    strategy:
      matrix:
        vm_version:
          - "v1.131.0"
          - "v1.131.0-enterprise"
          - "v1.122.10-enterprise"
          - "v1.110.25-enterprise"
      fail-fast: false
    outputs:
      tests: ${{ steps.tests.outcome }}
    permissions:
      checks: write
      contents: write
    if: github.event.pull_request.draft == false
    env:
      LABEL_FILTER: kind
      VM_VERSION: ${{ matrix.vm_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          check-latest: true
          cache: true
        id: go

      - name: Install ginkgo
        run: |
          go install github.com/onsi/ginkgo/v2/ginkgo

      - name: Download go packages
        run: |
          go mod download

      - name: Install helm
        uses: yokawasa/action-setup-kube-tools@v0.13.1
        with:
          setup-tools: |
            helmv3
            kubectl

      - name: Create Kind cluster
        uses: helm/kind-action@v1.13.0
        with:
          config: manifests/kind.yaml

      - name: Add helm repo
        run: |
          helm repo add vm https://victoriametrics.github.io/helm-charts/
          helm repo update

      - name: Install crust-gather
        uses: jaxxstorm/action-install-gh-release@v1.10.0
        with:
          repo: crust-gather/crust-gather
          platform: linux
          arch: amd64

      - name: Install VMExporter
        uses: jaxxstorm/action-install-gh-release@v1.10.0
        with:
          repo: VictoriaMetrics/support
          platform: linux
          arch: amd64
          token: ${{ secrets.PAT }}
          extension-matching: disable
          rename-to: vmexporter
          chmod: 0755

      - name: Run e2e tests
        id: tests
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission
          mkdir -p /tmp/allure-results
          ginkgo -v \
            -procs=0 \
            -github-output=true \
            -timeout=30m \
            --label-filter=${{ env.LABEL_FILTER }} \
            ./tests/${{ env.SUITE_LOAD }} \
            -- \
            -env-k8s-distro=kind \
            -vmtag=${{ matrix.vm_version }} \
            -report=/tmp/allure-results

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kind-${{ env.SUITE_LOAD }}-${{ matrix.vm_version }}
          path: /tmp/allure-results

  kind-chaos-test:
    name: Kind chaos test (${{ matrix.vm_version }})
    runs-on: ubuntu-latest
    needs: kind-smoke-test
    strategy:
      matrix:
        vm_version:
          - "v1.131.0"
          - "v1.131.0-enterprise"
          - "v1.122.10-enterprise"
          - "v1.110.25-enterprise"
      fail-fast: false
    outputs:
      tests: ${{ steps.tests.outcome }}
    permissions:
      checks: write
      contents: write
    if: github.event.pull_request.draft == false
    env:
      LABEL_FILTER: kind
      VM_VERSION: ${{ matrix.vm_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          check-latest: true
          cache: true
        id: go

      - name: Install ginkgo
        run: |
          go install github.com/onsi/ginkgo/v2/ginkgo

      - name: Download go packages
        run: |
          go mod download

      - name: Install helm
        uses: yokawasa/action-setup-kube-tools@v0.13.1
        with:
          setup-tools: |
            helmv3
            kubectl

      - name: Create Kind cluster
        uses: helm/kind-action@v1.13.0
        with:
          config: manifests/kind.yaml

      - name: Add helm repo
        run: |
          helm repo add vm https://victoriametrics.github.io/helm-charts/
          helm repo add chaos-mesh https://charts.chaos-mesh.org
          helm repo update

      - name: Install crust-gather
        uses: jaxxstorm/action-install-gh-release@v1.10.0
        with:
          repo: crust-gather/crust-gather
          platform: linux
          arch: amd64

      - name: Install VMExporter
        uses: jaxxstorm/action-install-gh-release@v1.10.0
        with:
          repo: VictoriaMetrics/support
          platform: linux
          arch: amd64
          token: ${{ secrets.PAT }}
          extension-matching: disable
          rename-to: vmexporter
          chmod: 0755

      - name: Run e2e tests
        id: tests
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission
          mkdir -p /tmp/allure-results
          ginkgo -v \
            -procs=0 \
            -github-output=true \
            -timeout=60m \
            --label-filter=${{ env.LABEL_FILTER }} \
            ./tests/${{ env.SUITE_CHAOS }} \
            -- \
            -env-k8s-distro=kind \
            -vmtag=${{ matrix.vm_version }} \
            -report=/tmp/allure-results

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kind-${{ env.SUITE_CHAOS }}-${{ matrix.vm_version }}
          path: /tmp/allure-results

  gke-smoke-test:
    name: GKE smoke test (${{ matrix.vm_version }})
    runs-on: ubuntu-latest
    needs: kind-smoke-test
    strategy:
      matrix:
        vm_version:
          - "v1.131.0"
          - "v1.131.0-enterprise"
          - "v1.122.10-enterprise"
          - "v1.110.25-enterprise"
      fail-fast: false
    outputs:
      tests: ${{ steps.tests.outcome }}
    permissions:
      checks: write
      contents: write
    if: github.event.pull_request.draft == false
    env:
      LABEL_FILTER: gke
      VM_VERSION: ${{ matrix.vm_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          check-latest: true
          cache: true
        id: go

      - name: Install ginkgo
        run: |
          go install github.com/onsi/ginkgo/v2/ginkgo

      - name: Download go packages
        run: |
          go mod download

      - name: Install helm
        uses: yokawasa/action-setup-kube-tools@v0.13.1
        with:
          setup-tools: |
            helmv3
            kubectl

      - name: Add helm repo
        run: |
          helm repo add vm https://victoriametrics.github.io/helm-charts/
          helm repo update

      - name: Install crust-gather
        uses: jaxxstorm/action-install-gh-release@v1.10.0
        with:
          repo: crust-gather/crust-gather
          platform: linux
          arch: amd64

      - name: Install VMExporter
        uses: jaxxstorm/action-install-gh-release@v1.10.0
        with:
          repo: VictoriaMetrics/support
          platform: linux
          arch: amd64
          token: ${{ secrets.PAT }}
          extension-matching: disable
          rename-to: vmexporter
          chmod: 0755

      - name: Google Auth
        uses: 'google-github-actions/auth@v3'
        with:
          credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'

      - uses: "google-github-actions/setup-gcloud@v2"
        with:
          install_components: "gke-gcloud-auth-plugin"

      - name: Retrieve terraform variables
        env:
          TF_VAR_BASE64: ${{ secrets.TF_VAR_BASE64 }}
        run: |
          echo $TF_VAR_BASE64 | base64 --decode > terraform/gke/terraform.tfvars

      - name: terraform apply
        id: tests-infra
        uses: dflook/terraform-apply@v2
        with:
          path: terraform/gke
          workspace: main
          variables: |
            cluster_name = "smoke-test-${{ github.run_number }}"
          auto_approve: true

      - name: Authenticate to GKE cluster
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ steps.tests-infra.outputs.cluster_name }}
          location: ${{ steps.tests-infra.outputs.region }}
          project_id: ${{ steps.tests-infra.outputs.project_id }}

      - name: create admin serviceaccount kubeconfig
        id: kubeconfig
        run: |
          kubectl -n kube-system create serviceaccount cluster-admin
          kubectl create clusterrolebinding cluster-admin-binding --clusterrole=cluster-admin --serviceaccount=kube-system:cluster-admin
          kubectl -n kube-system create token --duration=24h cluster-admin > /tmp/token.txt
          kubectl config view --raw --minify -o jsonpath='{.clusters[0].cluster.certificate-authority-data}' | base64 -d > /tmp/ca.txt
          kubectl config view --raw --minify -o jsonpath='{.clusters[0].cluster.server}' > /tmp/server.txt
          export KUBECONFIG=/tmp/kubeconfig.yaml
          kubectl config set-cluster gke --server=$(cat /tmp/server.txt) --certificate-authority=/tmp/ca.txt --embed-certs=true
          kubectl config set-credentials cluster-admin --token=$(cat /tmp/token.txt)
          kubectl config set-context production --cluster gke --user cluster-admin
          kubectl config use-context production

      - name: Run e2e tests
        id: tests
        run: |
          export KUBECONFIG=/tmp/kubeconfig.yaml
          mkdir -p /tmp/allure-results
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          ginkgo -v \
            -procs=0 \
            -github-output=true \
            -timeout=30m \
            --label-filter=${{ env.LABEL_FILTER }} \
            ./tests/${{ env.SUITE_SMOKE }} --\
            -env-k8s-distro=gke \
            -vmtag=${{ matrix.vm_version }} \
            -report=/tmp/allure-results

      - name: terraform destroy
        uses: dflook/terraform-destroy-workspace@v2
        if: always()
        with:
          path: terraform/gke
          workspace: main

      - name: Remove unused disks
        if: always()
        run: |
          gcloud compute disks delete --quiet $(gcloud compute disks list --filter="-users:*" --format "value(name)") --region=${{ steps.tests-infra.outputs.region }} || true

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gke-${{ env.SUITE_SMOKE }}-${{ matrix.vm_version }}
          path: /tmp/allure-results

  gke-load-test:
    name: GKE load test (${{ matrix.vm_version }})
    runs-on: ubuntu-latest
    needs: [gke-smoke-test, kind-load-test]
    strategy:
      matrix:
        vm_version:
          - "v1.131.0"
          - "v1.131.0-enterprise"
          - "v1.122.10-enterprise"
          - "v1.110.25-enterprise"
      fail-fast: false
    outputs:
      tests: ${{ steps.tests.outcome }}
    permissions:
      checks: write
      contents: write
    if: github.event.pull_request.draft == false
    env:
      LABEL_FILTER: gke
      VM_VERSION: ${{ matrix.vm_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          check-latest: true
          cache: true
        id: go

      - name: Install ginkgo
        run: |
          go install github.com/onsi/ginkgo/v2/ginkgo

      - name: Download go packages
        run: |
          go mod download

      - name: Install helm
        uses: yokawasa/action-setup-kube-tools@v0.13.1
        with:
          setup-tools: |
            helmv3
            kubectl

      - name: Add helm repo
        run: |
          helm repo add vm https://victoriametrics.github.io/helm-charts/
          helm repo update

      - name: Install crust-gather
        uses: jaxxstorm/action-install-gh-release@v1.10.0
        with:
          repo: crust-gather/crust-gather
          platform: linux
          arch: amd64

      - name: Install VMExporter
        uses: jaxxstorm/action-install-gh-release@v1.10.0
        with:
          repo: VictoriaMetrics/support
          platform: linux
          arch: amd64
          token: ${{ secrets.PAT }}
          extension-matching: disable
          rename-to: vmexporter
          chmod: 0755

      - name: Google Auth
        uses: 'google-github-actions/auth@v3'
        with:
          credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'

      - uses: "google-github-actions/setup-gcloud@v2"
        with:
          install_components: "gke-gcloud-auth-plugin"

      - name: Retrieve terraform variables
        env:
          TF_VAR_BASE64: ${{ secrets.TF_VAR_BASE64 }}
        run: |
          echo $TF_VAR_BASE64 | base64 --decode > terraform/gke/terraform.tfvars

      - name: terraform apply
        id: tests-infra
        uses: dflook/terraform-apply@v2
        with:
          path: terraform/gke
          workspace: main
          variables: |
            cluster_name = "load-test-${{ github.run_number }}"
          auto_approve: true

      - name: Authenticate to GKE cluster
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ steps.tests-infra.outputs.cluster_name }}
          location: ${{ steps.tests-infra.outputs.region }}
          project_id: ${{ steps.tests-infra.outputs.project_id }}

      - name: create admin serviceaccount kubeconfig
        id: kubeconfig
        run: |
          kubectl -n kube-system create serviceaccount cluster-admin
          kubectl create clusterrolebinding cluster-admin-binding --clusterrole=cluster-admin --serviceaccount=kube-system:cluster-admin
          kubectl -n kube-system create token --duration=24h cluster-admin > /tmp/token.txt
          kubectl config view --raw --minify -o jsonpath='{.clusters[0].cluster.certificate-authority-data}' | base64 -d > /tmp/ca.txt
          kubectl config view --raw --minify -o jsonpath='{.clusters[0].cluster.server}' > /tmp/server.txt
          export KUBECONFIG=/tmp/kubeconfig.yaml
          kubectl config set-cluster gke --server=$(cat /tmp/server.txt) --certificate-authority=/tmp/ca.txt --embed-certs=true
          kubectl config set-credentials cluster-admin --token=$(cat /tmp/token.txt)
          kubectl config set-context production --cluster gke --user cluster-admin
          kubectl config use-context production

      - name: Run e2e tests
        id: tests
        run: |
          export KUBECONFIG=/tmp/kubeconfig.yaml
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          mkdir -p /tmp/allure-results
          ginkgo -v \
            -procs=0 \
            -github-output=true \
            -timeout=30m \
            --label-filter=${{ env.LABEL_FILTER }} \
            ./tests/${{ env.SUITE_LOAD }} --\
            -env-k8s-distro=gke \
            -vmtag=${{ matrix.vm_version }} \
            -report=/tmp/allure-results

      - name: terraform destroy
        uses: dflook/terraform-destroy-workspace@v2
        if: always()
        with:
          path: terraform/gke
          workspace: main

      - name: Remove unused disks
        if: always()
        run: |
          gcloud compute disks delete --quiet $(gcloud compute disks list --filter="-users:*" --format "value(name)") --region=${{ steps.tests-infra.outputs.region }} || true

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gke-${{ env.SUITE_LOAD }}-${{ matrix.vm_version }}
          path: /tmp/allure-results

  gke-chaos-test:
    name: GKE chaos test (${{ matrix.vm_version }})
    runs-on: ubuntu-latest
    needs: [gke-smoke-test, kind-chaos-test]
    strategy:
      matrix:
        vm_version:
          - "v1.131.0"
          - "v1.131.0-enterprise"
          - "v1.122.10-enterprise"
          - "v1.110.25-enterprise"
      fail-fast: false
    outputs:
      tests: ${{ steps.tests.outcome }}
    permissions:
      checks: write
      contents: write
    if: github.event.pull_request.draft == false
    env:
      LABEL_FILTER: gke
      VM_VERSION: ${{ matrix.vm_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          check-latest: true
          cache: true
        id: go

      - name: Install ginkgo
        run: |
          go install github.com/onsi/ginkgo/v2/ginkgo

      - name: Download go packages
        run: |
          go mod download

      - name: Install helm
        uses: yokawasa/action-setup-kube-tools@v0.13.1
        with:
          setup-tools: |
            helmv3
            kubectl

      - name: Add helm repo
        run: |
          helm repo add vm https://victoriametrics.github.io/helm-charts/
          helm repo add chaos-mesh https://charts.chaos-mesh.org
          helm repo update

      - name: Install crust-gather
        uses: jaxxstorm/action-install-gh-release@v1.10.0
        with:
          repo: crust-gather/crust-gather
          platform: linux
          arch: amd64

      - name: Install VMExporter
        uses: jaxxstorm/action-install-gh-release@v1.10.0
        with:
          repo: VictoriaMetrics/support
          platform: linux
          arch: amd64
          token: ${{ secrets.PAT }}
          extension-matching: disable
          rename-to: vmexporter
          chmod: 0755

      - name: Google Auth
        uses: 'google-github-actions/auth@v3'
        with:
          credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'

      - uses: "google-github-actions/setup-gcloud@v2"
        with:
          install_components: "gke-gcloud-auth-plugin"

      - name: Retrieve terraform variables
        env:
          TF_VAR_BASE64: ${{ secrets.TF_VAR_BASE64 }}
        run: |
          echo $TF_VAR_BASE64 | base64 --decode > terraform/gke/terraform.tfvars

      - name: terraform apply
        id: tests-infra
        uses: dflook/terraform-apply@v2
        with:
          path: terraform/gke
          workspace: main
          variables: |
            cluster_name = "chaos-test-${{ github.run_number }}"
          auto_approve: true

      - name: Authenticate to GKE cluster
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ steps.tests-infra.outputs.cluster_name }}
          location: ${{ steps.tests-infra.outputs.region }}
          project_id: ${{ steps.tests-infra.outputs.project_id }}

      - name: create admin serviceaccount kubeconfig
        id: kubeconfig
        run: |
          kubectl -n kube-system create serviceaccount cluster-admin
          kubectl create clusterrolebinding cluster-admin-binding --clusterrole=cluster-admin --serviceaccount=kube-system:cluster-admin
          kubectl -n kube-system create token --duration=24h cluster-admin > /tmp/token.txt
          kubectl config view --raw --minify -o jsonpath='{.clusters[0].cluster.certificate-authority-data}' | base64 -d > /tmp/ca.txt
          kubectl config view --raw --minify -o jsonpath='{.clusters[0].cluster.server}' > /tmp/server.txt
          export KUBECONFIG=/tmp/kubeconfig.yaml
          kubectl config set-cluster gke --server=$(cat /tmp/server.txt) --certificate-authority=/tmp/ca.txt --embed-certs=true
          kubectl config set-credentials cluster-admin --token=$(cat /tmp/token.txt)
          kubectl config set-context production --cluster gke --user cluster-admin
          kubectl config use-context production

      - name: Run e2e tests
        id: tests
        run: |
          export KUBECONFIG=/tmp/kubeconfig.yaml
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          mkdir -p /tmp/allure-results
          ginkgo -v \
            -github-output=true \
            -procs=0 \
            -timeout=180m \
            --label-filter=${{ env.LABEL_FILTER }} \
            ./tests/${{ env.SUITE_CHAOS }} --\
            -env-k8s-distro=gke \
            -vmtag=${{ matrix.vm_version }} \
            -report=/tmp/allure-results

      - name: terraform destroy
        uses: dflook/terraform-destroy-workspace@v2
        if: always()
        with:
          path: terraform/gke
          workspace: main

      - name: Remove unused disks
        if: always()
        run: |
          gcloud compute disks delete --quiet $(gcloud compute disks list --filter="-users:*" --format "value(name)") --region=${{ steps.tests-infra.outputs.region }} || true

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gke-${{ env.SUITE_CHAOS }}-${{ matrix.vm_version }}
          path: /tmp/allure-results

  deploy-report:
    if: always()
    name: Generate and deploy Allure Report
    needs: [kind-smoke-test, kind-load-test, kind-chaos-test, gke-smoke-test, gke-load-test, gke-chaos-test]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          token: ${{ secrets.PAT }}
        continue-on-error: true

      - name: Download artifacts - All test results
        if: always()
        uses: actions/download-artifact@v4
        with:
          pattern: "*-v*"
          path: allure-results
          merge-multiple: true

      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        id: allure-report
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v2
        env:
          PERSONAL_TOKEN: ${{ secrets.PAT }}
          PUBLISH_BRANCH: gh-pages
          PUBLISH_DIR: allure-history

      - name: Post reports link
        if: always()
        uses: guibranco/github-status-action-v2@latest
        with:
          authToken: ${{ secrets.PAT }}
          context: 'Test report'
          state: ${{ needs.kind-smoke-tests.outputs.tests == 'success' && needs.kind-load-tests.outputs.tests == 'success' && needs.kind-chaos-tests.outputs.tests == 'success' && needs.gke-smoke-tests.outputs.tests == 'success' && needs.gke-load-tests.outputs.tests == 'success' && needs.gke-chaos-tests.outputs.tests == 'success' && 'success' || 'failure' }}
          sha: ${{ github.event.pull_request.head.sha || github.sha }}
          target_url: ${{ env.GH_PAGES_URL }}/${{ github.run_number }}/
