version: v1.0
name: VictoriaMetrics E2E Tests

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2404
execution_time_limit:
  hours: 2
auto_cancel:
  queued:
    when: 'true'
global_job_config:
  env_vars:
    # Set LICENSE_FILE to /home/semaphore to enable passing the license file to VictoriaMetrics components
    - name: LICENSE_FILE
      value: "/home/semaphore/license.txt"
    # Set VMSingle version (image tag) here
    - name: VM_VMSINGLEDEFAULT_VERSION
      value: "v1.122.15-enterprise"
    # Set VMCluster version (image tag) here
    - name: VM_VMCLUSTERDEFAULT_VERSION
      value: "v1.122.15-cluster-enterprise"
    # Set to non-empty value if enterprise features are enabled
    - name: VM_ENTERPRISE
      value: "true"
    - name: GO_VERSION
      value: "1.25.3"

blocks:
  - name: Unit Tests
    dependencies: []
    task:
      jobs:
        - name: run-unit-tests
          commands:
            - checkout
            - sem-version go $GO_VERSION
            - make test-unit
  - name: Smoke Test
    dependencies:
      - Unit Tests
    task:
      secrets:
        - name: license
      prologue:
        commands:
          - checkout
          - sem-version go $GO_VERSION
      jobs:
        - name: smoke-test
          commands:
            - make test-kind
      epilogue:
        always:
          commands:
            - artifact push workflow /tmp/allure-results
  - name: GKE Tests
    dependencies:
      - Smoke Test
    task:
      secrets:
        - name: gcp-credentials
        - name: license
      prologue:
        commands:
          - checkout
          - sem-version go $GO_VERSION
      jobs:
        - name: Test matrix
          commands:
            - |
              export SUITE=$(echo $TEST | cut -d' ' -f1)
              export PROCS=$(echo $TEST | cut -d' ' -f2)
              make test-gke TEST_SUITE=$SUITE PROCS=$PROCS TIMEOUT=90m
          matrix:
            - env_var: TEST
              values:
                - "load 1"
                - "distributed 10"
                - "vmsingle 10"
                - "vmcluster 10"
                - "chaos 10"
      epilogue:
        always:
          commands:
            - export SUITE=$(echo $TEST | cut -d' ' -f1); make clean-gke TEST_SUITE=$SUITE
            - artifact push workflow /tmp/allure-results
after_pipeline:
  task:
    secrets:
      - name: gcp-credentials
    jobs:
      - name: deploy-report
        commands:
          - nvm install 22
          - nvm use 22
          - artifact pull workflow allure-results
          - |
            for dir in $(find ./allure-results -type d -maxdepth 1 -mindepth 1); do
              npx allure awesome --single-file -o ./report-$dir $dir
              artifact push workflow ./report-$dir
            done
